#!/usr/bin/env node

/**
 * Module dependencies.
 */

var jss = require('../')
  , fs = require('fs');

/**
 * Arguments.
 */

var args = process.argv.slice(2);

/**
 * Paths to process.
 */

var paths = [];

/**
 * Statistics.
 */

var stats = {};

/**
 * Options.
 */

var options = { format: 'json' };

/**
 * Usage docs.
 */

var usage = [
    ''
  , '  Usage: jss [options] [file|dir ...]'
  , ''
  , '  Options:'
  , ''
  , '    -f, --format <name>  Output the given format. text, json'
  , '    -t, --text           Output human-readable plain-text stats'
  , '    -V, --version        Display the version of jss'
  , '    -h, --help           Display help information'
  , ''
].join('\n');

/**
 * Handle arguments.
 */

var arg;
while (args.length) {
  arg = args.shift();
  switch (arg) {
    case '-h':
    case '--help':
    case 'help':
      console.log(usage);
      process.exit(1);
    case '-V':
    case '--version':
      console.log(jss.version);
      process.exit(0);
      break;
    case '-t':
    case '--text':
      options.format = 'text';
      break;
    default:
      paths.push(arg);
  }
}

// process

jss.find(paths, function(err, files){
  var pending = files.length;
  files.forEach(function(file){
    fs.readFile(file, 'utf8', function(err, str){
      if (err) throw err;
      stats[file] = jss.stats(str);
      --pending || done();
    });
  });
});

// finished

function done() {
  if (options.text) {}
  var format = jss.formats[options.format];
  if (!format) throw new Error('invalid format "' + options.format + '"');
  format(stats);
}